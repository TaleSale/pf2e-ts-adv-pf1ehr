<form class="rebellion-sheet-form" autocomplete="off">
    <div class="sheet-container">
        <div class="points-section">
            <div class="liberation-box">
                <div class="box-header">Очки Освобождения</div>
                <div class="box-value liberation-value">
                    <span>{{rebellion.liberation}}</span>
                    <a class="roll-icon" data-action="roll-liberation" title="Проверка Опознания (1d100 vs Очки Освобождения)"><i class="fas fa-dice-d20"></i></a>
                </div>
                <div class="sub-points-grid">
                    <div class="sub-point-box"><div class="sub-point-header">Верность</div><div class="sub-point-value">{{rebellion.loyalty}}</div></div>
                    <div class="plus-sign">+</div>
                    <div class="sub-point-box"><div class="sub-point-header">Скрытность</div><div class="sub-point-value">{{rebellion.secrecy}}</div></div>
                    <div class="plus-sign">+</div>
                    <div class="sub-point-box"><div class="sub-point-header">Безопасность</div><div class="sub-point-value">{{rebellion.security}}</div></div>
                </div>
            </div>
            <div class="authority-box">
                <div class="box-header">Очки Власти</div>
                <div class="box-value authority-value">
                    {{#if isGM}}<button type="button" class="point-change-btn" data-action="change-points" data-category="authority" data-amount="-1"><i class="fas fa-minus"></i></button>{{/if}}
                    <span>{{rebellion.authority}}</span>
                    {{#if isGM}}<button type="button" class="point-change-btn" data-action="change-points" data-category="authority" data-amount="1"><i class="fas fa-plus"></i></button>{{/if}}
                </div>
                <div class="authority-rules"><ul><li><strong>(+)</strong> за каждого захваченного ПИ</li><li><strong>(-)</strong> за победу над союзниками Труна</li></ul></div>
            </div>
            <div class="task-level-box">
                <div class="box-header">Уровень Задачи</div>
                <div class="box-value task-level-value">
                    {{#if isGM}}<button type="button" class="point-change-btn" data-action="change-task-level" data-amount="-1" title="Уменьшить уровень"><i class="fas fa-minus"></i></button>{{/if}}
                    <span>{{rebellion.taskLevel}}</span>
                    {{#if isGM}}<button type="button" class="point-change-btn" data-action="change-task-level" data-amount="1" title="Увеличить уровень"><i class="fas fa-plus"></i></button>{{/if}}
                </div>
                <div class="task-dc-display">КС: {{rebellion.taskDC}}</div>
            </div>
        </div>

        <div class="assets-section">
            {{#each rebellion.assets as |assets category|}}
            <div class="asset-column" data-category="{{category}}">
                <div class="asset-column-header">Активы: {{#if (eq category 'loyalty')}}Верность{{/if}}{{#if (eq category 'secrecy')}}Скрытность{{/if}}{{#if (eq category 'security')}}Безопасность{{/if}}</div>
                <div class="asset-column-subheader">
                    <span>Очки</span>
                    {{#if ../isGM}}
                    <div class="point-controls">
                        <button type="button" class="point-change-btn" data-action="change-points" data-category="{{category}}" data-amount="-1" title="Уменьшить очки"><i class="fas fa-minus"></i></button>
                        <button type="button" class="point-change-btn" data-action="change-points" data-category="{{category}}" data-amount="1" title="Увеличить очки"><i class="fas fa-plus"></i></button>
                    </div>
                    {{/if}}
                    <a class="roll-icon" data-action="roll-bonus" data-category="{{category}}" data-label="{{#if (eq category 'loyalty')}}Верность{{/if}}{{#if (eq category 'secrecy')}}Скрытность{{/if}}{{#if (eq category 'security')}}Безопасность{{/if}}" title="Бросок 1d20 + Очки"><i class="fas fa-dice-d20"></i></a>
                </div>
                <div class="asset-rows-container">
                    {{#each assets}}
                    {{#if this.isEditing}}
                    <div class="asset-edit-row" data-asset-id="{{this.id}}">
                        <textarea class="asset-desc" data-field="description" placeholder="Описание актива...">{{this.description}}</textarea>
                        <div class="asset-edit-controls">
                            <input class="asset-pts" type="number" value="{{this.points}}" data-field="points">
                            <a class="asset-ctrl asset-save" data-action="save-asset" title="Сохранить"><i class="fas fa-save"></i></a>
                            <a class="asset-ctrl asset-delete" data-action="delete-asset" title="Удалить"><i class="fas fa-trash"></i></a>
                        </div>
                    </div>
                    {{else}}
                    <div class="asset-view-row" data-asset-id="{{this.id}}">
                        <div class="asset-view-desc">{{this.description}}</div>
                        <div class="asset-view-pts">{{this.points}}</div>
                        <a class="asset-ctrl asset-edit" data-action="edit-asset" title="Изменить"><i class="fas fa-edit"></i></a>
                    </div>
                    {{/if}}
                    {{/each}}
                </div>
                <button type="button" class="add-asset-btn" data-action="add-asset" data-category="{{category}}"><i class="fas fa-plus"></i> Добавить</button>
            </div>
            {{/each}}
        </div>
    </div>

    <style>
        /* Общие стили */
        .rebellion-sheet-window .window-content { padding: 0; background: url(systems/pf2e/assets/sheet/parchment.jpg); }
        .rebellion-sheet-form { font-family: sans-serif; color: #191813; }
        .sheet-container { display: flex; flex-direction: column; height: 100%; }
        .points-section { display: grid; grid-template-columns: 2fr 1.1fr 1.1fr; border-bottom: 2px solid #385d8a; }
        .liberation-box, .authority-box, .task-level-box { padding: 10px; }
        .liberation-box, .authority-box { border-right: 1px solid #b5b3a8; }
        .box-header { background-color: #385d8a; color: white; text-align: center; padding: 8px; font-weight: bold; }
        .box-value { text-align: center; font-size: 3em; font-weight: bold; padding: 15px 0; }
        .authority-value, .liberation-value, .task-level-value { display: flex; justify-content: center; align-items: center; gap: 15px; }
        .task-level-value { padding-bottom: 5px; }
        .task-dc-display { font-size: 1.1em; padding-top: 5px; color: #444; text-align: center; font-weight: bold; border-top: 1px solid #b5b3a8; margin: 0 10px; }
        .sub-points-grid { display: grid; grid-template-columns: 1fr auto 1fr auto 1fr; align-items: center; text-align: center; background-color: #385d8a; color: white; }
        .sub-point-header { font-weight: bold; padding: 5px; }
        /* *** ИЗМЕНЕНО: Исправлен код цвета на #191813 *** */
        .sub-point-value { background-color: #e9e7e2; color: #191813; padding: 10px; font-size: 1.5em; font-weight: bold; border-top: 1px solid #385d8a; }
        .plus-sign { font-size: 1.5em; font-weight: bold; }
        .authority-rules { font-size: 0.9em; padding: 10px; color: #444; }
        .authority-rules ul { margin: 0; padding-left: 20px; }
        .point-controls { display: flex; gap: 5px; }
        .point-change-btn { background: #e9e7e2; border: 1px solid #aaa; color: #191813; cursor: pointer; width: 24px; height: 24px; }
        .roll-icon { font-size: 1.2em; margin-left: 10px; cursor: pointer; color: #666; }
        #rebellion-sheet-button { display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; margin: 0 4px; vertical-align: middle; color: #f0f0e0; font-family: 'Signika', sans-serif; font-weight: bold; font-size: 14px; text-decoration: none; border: 1px solid #555; border-radius: 3px; background-color: rgba(150, 50, 50, 0.7); cursor: pointer; }
        #rebellion-sheet-button:hover { background-color: rgba(200, 50, 50, 1); }

        /* Стили для активов */
        .assets-section { display: flex; flex-grow: 1; min-height: 0; }
        .asset-column { display: flex; flex-direction: column; flex: 1; border-right: 1px solid #b5b3a8; min-width: 0; }
        .asset-column:last-child { border-right: none; }
        .asset-column-header { padding: 8px; font-weight: bold; text-align: center; border-bottom: 1px solid #b5b3a8; flex-shrink: 0; }
        .asset-column-subheader { display: grid; grid-template-columns: 1fr auto auto; align-items: center; padding: 5px 8px; border-bottom: 1px solid #b5b3a8; font-weight: bold; flex-shrink: 0; }
        .asset-rows-container { padding: 5px; flex-grow: 1; overflow-y: auto; }
        .asset-ctrl { flex-shrink: 0; width: 25px; text-align: center; cursor: pointer; padding-top: 4px; font-size: 1.1em; }
        .asset-save { color: #080; }
        .asset-delete { color: #900; }
        .asset-edit { color: #385d8a; }
        .asset-edit-row { display: flex; flex-direction: column; gap: 5px; padding: 5px; margin-bottom: 5px; background-color: #e9e7e2; border: 1px solid #aaa; border-radius: 3px; }
        .asset-desc { border: 1px solid #aaa; background: #fff; color: #191813; resize: none; font-family: inherit; font-size: 0.9em; padding: 4px; overflow-y: hidden; border-radius: 3px; width: 100%; }
        .asset-edit-controls { display: flex; align-items: center; gap: 5px; }
        .asset-pts { flex-grow: 1; text-align: center; border: 1px solid #aaa; background: #fff; color: #191813; border-radius: 3px; height: 28px; }
        .asset-view-row { display: flex; gap: 8px; align-items: center; padding: 8px 5px; margin-bottom: 5px; background-color: transparent; border: 1px solid transparent; border-bottom-color: #dcdad3; }
        .asset-view-desc { flex-grow: 1; font-size: 0.95em; white-space: pre-wrap; }
        .asset-view-pts { flex-shrink: 0; font-weight: bold; font-size: 1.1em; width: 25px; text-align: center; }
        .add-asset-btn { margin: 8px; padding: 5px; border: 1px dashed #aaa; background: #e9e7e2; color: #191813; cursor: pointer; text-align: center; flex-shrink: 0; }
    </style>
</form>